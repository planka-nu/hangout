<html>
	<head>
		<title>Chat</title>
		<link rel="stylesheet" href="/stylesheets/app.css">
		<script src="socket.io/socket.io.js"></script>
		<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.1.3.min.js"></script>
		<script>
			$(document).ready(function () {

				var roomDivs = {};

				var socket = io.connect('http://localhost:8080');
				socket.on('connect', function() {

					socket.once('nickname', function (nickname) {
						// First time nickname is set from server, we know we have a connection and everything is initialized.
						$('#wrapper').show();
					});

					// Handle nick name changes:

					socket.on('nickname', function (nickname) {
						$('#nickname').val(nickname);
					});
					$('#nickname').change(function () {
						socket.emit('nickname', $(this).val());
					});

					// Handle room joins:
					socket.on('join', function (room) {
						console.log(room);
						if (typeof roomDivs[room] === 'undefined') {
							roomDivs[room] = $('<div><h2></h2><a href="#" class="leaveroom">Leave room</a><ul class="msgs"></ul><input type="text" /></div>');
							$('#rooms').append(roomDivs[room]);
							$('h2', roomDivs[room]).append(document.createTextNode(room));
							$('a.leaveroom', roomDivs[room]).click(function () {
								socket.emit('leave', room);
							});
							$('input', roomDivs[room]).keypress(function (e) {
								if (e.which === 13) {
									var msg = $(this).val();
									$(this).val('');
									socket.emit('message', room, msg);
								}
							});
						}
					});
					$('#joinroom').click(function () {
						socket.emit('join', $('#roomname').val());
						$('#roomname').val('');
					});

					// Handle messages:
					socket.on('message', function (room, nick, msg) {
						if (typeof roomDivs[room] === 'undefined') {
							console.error('Message in unknown room: ' + room + ': ' + msg);
							return;
						}
						var li = $('<li><span class="nick"></span> <span class="msg"></span></li>');
						$('span.nick', li).append(document.createTextNode(nick));
						$('span.msg', li).append(document.createTextNode(msg));
						$('ul.msgs', roomDivs[room]).append(li);
					});

					// Output errors to console.
					socket.on('errormsg', function (msg) {
						console.error(msg);
					});

				});
			});
		</script>
		<style>
			#wrapper {
				display: none;
			}
		</style>
	</head>
	<body>
		<div id="wrapper">

			<div>
				Nickname: <input id="nickname" />
			</div>

			<div>
				Join room: <input id="roomname" /><input type="button" id="joinroom" value="Join!" />
			</div>

			<div id="rooms"></div>
			
		</div>
	</body>
</html>
